<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Middle-earth Map Builder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .canvas-area {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #0d0d1a;
        }

        #mapCanvas {
            position: absolute;
            cursor: grab;
            background: #2a2a3e;
        }

        #mapCanvas:active {
            cursor: grabbing;
        }

        .sidebar {
            width: 380px;
            background: #16213e;
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid #333;
        }

        h1 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #ffd700;
        }

        h2 {
            font-size: 0.9rem;
            margin: 15px 0 8px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .coords-display {
            background: #0d0d1a;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-family: monospace;
        }

        .coords-display .label {
            color: #888;
            font-size: 0.75rem;
        }

        .coords-display .value {
            font-size: 1.1rem;
            color: #4ade80;
        }

        .poi-type-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 15px;
        }

        .poi-type-btn {
            padding: 6px 10px;
            border: 1px solid #444;
            background: #1a1a2e;
            color: #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .poi-type-btn:hover {
            background: #2a2a4e;
        }

        .poi-type-btn.active {
            background: #ffd700;
            color: #000;
            border-color: #ffd700;
        }

        .quick-names {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
            max-height: 120px;
            overflow-y: auto;
        }

        .quick-name-btn {
            padding: 4px 8px;
            border: 1px solid #555;
            background: #2a2a4e;
            color: #ddd;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7rem;
        }

        .quick-name-btn:hover {
            background: #3a3a5e;
            border-color: #ffd700;
        }

        .quick-name-btn.used {
            opacity: 0.4;
            text-decoration: line-through;
        }

        .poi-list {
            max-height: 250px;
            overflow-y: auto;
        }

        .poi-item {
            background: #0d0d1a;
            padding: 8px 10px;
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .poi-item .poi-info {
            flex: 1;
        }

        .poi-item .poi-name {
            color: #ffd700;
            font-weight: bold;
        }

        .poi-item .poi-coords {
            color: #888;
            font-family: monospace;
            font-size: 0.7rem;
        }

        .poi-item button {
            background: #dc2626;
            border: none;
            color: white;
            padding: 3px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7rem;
        }

        .btn-row {
            display: flex;
            gap: 10px;
        }

        .export-btn {
            flex: 1;
            padding: 10px;
            background: #4ade80;
            border: none;
            color: #000;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
        }

        .export-btn:hover {
            background: #22c55e;
        }

        .clear-btn {
            padding: 10px 15px;
            background: #dc2626;
            border: none;
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
        }

        .instructions {
            background: #0d0d1a;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.8rem;
            line-height: 1.4;
            color: #aaa;
        }

        .instructions strong {
            color: #ffd700;
        }

        #output {
            background: #000;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.65rem;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
            display: none;
            margin-top: 10px;
        }

        .canvas-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 5px;
            z-index: 100;
        }

        .canvas-controls button {
            padding: 8px 12px;
            background: rgba(30, 30, 50, 0.9);
            border: 1px solid #555;
            color: #fff;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .canvas-controls button:hover {
            background: rgba(50, 50, 80, 0.9);
        }

        .zoom-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #aaa;
        }

        .mode-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 215, 0, 0.9);
            color: #000;
            padding: 8px 15px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="canvas-area" id="canvasArea">
            <div class="canvas-controls">
                <button onclick="zoomIn()">+ Zoom</button>
                <button onclick="zoomOut()">- Zoom</button>
                <button onclick="resetView()">Reset View</button>
                <button onclick="fitToScreen()">Fit</button>
                <button onclick="toggleGrid()">Grid</button>
            </div>
            <div class="mode-indicator" id="modeIndicator">Pan Mode (Hold SHIFT to place)</div>
            <canvas id="mapCanvas"></canvas>
            <div class="zoom-info" id="zoomInfo">Zoom: 100%</div>
        </div>

        <div class="sidebar">
            <h1>Middle-earth Map Builder</h1>

            <div class="instructions">
                <strong>Scroll</strong> to zoom | <strong>Drag</strong> to pan<br>
                <strong>Shift+Click</strong> to place a POI
            </div>

            <h2>Current Position</h2>
            <div class="coords-display">
                <div class="label">Map Position (percent)</div>
                <div class="value" id="percentCoords">---, ---</div>
            </div>

            <h2>POI Type</h2>
            <div class="poi-type-selector">
                <button class="poi-type-btn active" data-type="landmark" onclick="selectType(this)">Landmark</button>
                <button class="poi-type-btn" data-type="mountain" onclick="selectType(this)">Mountain</button>
                <button class="poi-type-btn" data-type="city" onclick="selectType(this)">City</button>
                <button class="poi-type-btn" data-type="forest" onclick="selectType(this)">Forest</button>
                <button class="poi-type-btn" data-type="water" onclick="selectType(this)">Water</button>
                <button class="poi-type-btn" data-type="path" onclick="selectType(this)">Path</button>
            </div>

            <h2>Quick Names (click to select)</h2>
            <div class="quick-names" id="quickNames"></div>

            <h2>Placed POIs (<span id="poiCount">0</span>)</h2>
            <div class="poi-list" id="poiList"></div>

            <div class="btn-row">
                <button class="export-btn" onclick="exportPOIs()">Export JSON</button>
                <button class="clear-btn" onclick="clearAll()">Clear All</button>
            </div>

            <pre id="output"></pre>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('mapCanvas');
        const ctx = canvas.getContext('2d');
        const canvasArea = document.getElementById('canvasArea');

        // Map state
        let mapImage = null;
        let imageWidth = 7680;
        let imageHeight = 4386;

        // View state
        let zoom = 0.15;
        let panX = 0;
        let panY = 0;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let lastPanX = 0;
        let lastPanY = 0;

        // UI state
        let showGrid = false;
        let selectedType = 'landmark';
        let selectedName = '';
        let pois = [];

        // Known POI names from the journey
        const knownPOIs = [
            'Hobbiton', 'Bree', 'Weathertop', 'Rivendell', 'Hollin Ridge',
            'West Gate of Moria', 'Exit of Moria', 'Lothlórien', 'Argonath',
            'Dead Marshes', 'Black Gate', 'Morgul Road', 'Cirith Ungol', 'Mount Doom',
            // Additional POIs you might want
            'Minas Tirith', 'Minas Morgul', 'Barad-dûr', 'Isengard', 'Fangorn Forest',
            'Helm\'s Deep', 'Edoras', 'Osgiliath', 'Pelennor Fields', 'Grey Havens',
            'Amon Hen', 'Rauros Falls', 'Emyn Muil', 'Ithilien', 'Henneth Annûn'
        ];

        // Initialize
        function init() {
            // Set canvas size to viewport
            resizeCanvasToViewport();

            // Load the Middle-earth map image
            mapImage = new Image();
            mapImage.onload = function() {
                imageWidth = mapImage.width;
                imageHeight = mapImage.height;
                fitToScreen();
                redraw();
            };
            mapImage.src = 'assets/map.webp';

            // Set up event listeners
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mousedown', handleMouseDown);
            document.addEventListener('mousemove', handleDrag);
            document.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('wheel', handleWheel, { passive: false });
            canvas.addEventListener('click', handleClick);
            window.addEventListener('resize', resizeCanvasToViewport);

            // Populate quick names
            populateQuickNames();
        }

        function resizeCanvasToViewport() {
            canvas.width = canvasArea.clientWidth;
            canvas.height = canvasArea.clientHeight;
            redraw();
        }

        function populateQuickNames() {
            const container = document.getElementById('quickNames');
            container.innerHTML = knownPOIs.map(name =>
                `<button class="quick-name-btn" onclick="selectQuickName(this, '${name.replace(/'/g, "\\'")}')">${name}</button>`
            ).join('');
        }

        function selectQuickName(btn, name) {
            // Deselect all
            document.querySelectorAll('.quick-name-btn').forEach(b => b.style.background = '');
            // Select this one
            btn.style.background = '#ffd700';
            btn.style.color = '#000';
            selectedName = name;
        }

        function redraw() {
            // Clear canvas
            ctx.fillStyle = '#0d0d1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Save context for transformations
            ctx.save();

            // Apply pan and zoom
            ctx.translate(panX, panY);
            ctx.scale(zoom, zoom);

            // Draw the map image
            if (mapImage && mapImage.complete) {
                ctx.drawImage(mapImage, 0, 0, imageWidth, imageHeight);
            }

            // Draw grid
            if (showGrid) {
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
                ctx.lineWidth = 2 / zoom;

                // Draw percentage grid lines
                for (let p = 0; p <= 100; p += 10) {
                    const x = (p / 100) * imageWidth;
                    const y = (p / 100) * imageHeight;

                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, imageHeight);
                    ctx.stroke();

                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(imageWidth, y);
                    ctx.stroke();

                    // Labels
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.font = `${14 / zoom}px monospace`;
                    ctx.fillText(`${p}%`, x + 5 / zoom, 20 / zoom);
                    ctx.fillText(`${p}%`, 5 / zoom, y + 20 / zoom);
                }
            }

            // Draw POIs
            pois.forEach((poi, index) => {
                const x = (poi.x / 100) * imageWidth;
                const y = (poi.y / 100) * imageHeight;
                const radius = 12 / zoom;

                // Outer glow
                ctx.beginPath();
                ctx.arc(x, y, radius * 1.5, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255, 215, 0, 0.3)';
                ctx.fill();

                // Main marker
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                ctx.fillStyle = getTypeColor(poi.type);
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2 / zoom;
                ctx.stroke();

                // Label
                ctx.fillStyle = 'white';
                ctx.font = `bold ${12 / zoom}px sans-serif`;
                ctx.fillText(poi.name, x + radius * 1.5, y + 4 / zoom);
            });

            ctx.restore();

            // Update zoom display
            document.getElementById('zoomInfo').textContent = `Zoom: ${Math.round(zoom * 100)}%`;
        }

        function getTypeColor(type) {
            const colors = {
                mountain: '#8b4513',
                forest: '#228b22',
                city: '#ffd700',
                landmark: '#ff6b6b',
                water: '#4169e1',
                path: '#ffa500'
            };
            return colors[type] || '#fff';
        }

        function screenToMap(screenX, screenY) {
            const mapX = (screenX - panX) / zoom;
            const mapY = (screenY - panY) / zoom;
            return {
                x: (mapX / imageWidth) * 100,
                y: (mapY / imageHeight) * 100
            };
        }

        function handleMouseMove(e) {
            const rect = canvas.getBoundingClientRect();
            const screenX = e.clientX - rect.left;
            const screenY = e.clientY - rect.top;

            const mapCoords = screenToMap(screenX, screenY);
            document.getElementById('percentCoords').textContent =
                `${mapCoords.x.toFixed(2)}%, ${mapCoords.y.toFixed(2)}%`;

            // Update mode indicator
            const indicator = document.getElementById('modeIndicator');
            if (e.shiftKey) {
                indicator.textContent = 'PLACE MODE (Click to place POI)';
                indicator.style.background = '#4ade80';
                canvas.style.cursor = 'crosshair';
            } else {
                indicator.textContent = 'Pan Mode (Hold SHIFT to place)';
                indicator.style.background = 'rgba(255, 215, 0, 0.9)';
                canvas.style.cursor = isDragging ? 'grabbing' : 'grab';
            }
        }

        function handleMouseDown(e) {
            if (e.shiftKey) return; // Don't drag when placing

            isDragging = true;
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            lastPanX = panX;
            lastPanY = panY;
            canvas.style.cursor = 'grabbing';
        }

        function handleDrag(e) {
            if (!isDragging) return;

            const dx = e.clientX - dragStartX;
            const dy = e.clientY - dragStartY;
            panX = lastPanX + dx;
            panY = lastPanY + dy;
            redraw();
        }

        function handleMouseUp() {
            isDragging = false;
            canvas.style.cursor = 'grab';
        }

        function handleWheel(e) {
            e.preventDefault();

            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            // Zoom factor
            const factor = e.deltaY > 0 ? 0.9 : 1.1;
            const newZoom = Math.max(0.05, Math.min(2, zoom * factor));

            // Zoom toward mouse position
            const zoomRatio = newZoom / zoom;
            panX = mouseX - (mouseX - panX) * zoomRatio;
            panY = mouseY - (mouseY - panY) * zoomRatio;

            zoom = newZoom;
            redraw();
        }

        function handleClick(e) {
            if (!e.shiftKey) return; // Only place when shift is held

            const rect = canvas.getBoundingClientRect();
            const screenX = e.clientX - rect.left;
            const screenY = e.clientY - rect.top;

            const mapCoords = screenToMap(screenX, screenY);

            // Use selected name or prompt for one
            let name = selectedName;
            if (!name) {
                name = prompt(`Enter name for this ${selectedType}:`, `${selectedType} ${pois.length + 1}`);
                if (name === null) return;
            }

            pois.push({
                type: selectedType,
                name: name,
                x: parseFloat(mapCoords.x.toFixed(2)),
                y: parseFloat(mapCoords.y.toFixed(2))
            });

            // Mark quick name as used
            if (selectedName) {
                document.querySelectorAll('.quick-name-btn').forEach(btn => {
                    if (btn.textContent === selectedName) {
                        btn.classList.add('used');
                        btn.style.background = '';
                        btn.style.color = '';
                    }
                });
                selectedName = '';
            }

            updatePOIList();
            redraw();
        }

        function selectType(btn) {
            document.querySelectorAll('.poi-type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedType = btn.dataset.type;
        }

        function updatePOIList() {
            const list = document.getElementById('poiList');
            document.getElementById('poiCount').textContent = pois.length;

            list.innerHTML = pois.map((poi, i) => `
                <div class="poi-item">
                    <div class="poi-info">
                        <div class="poi-name">${poi.name}</div>
                        <div class="poi-coords">${poi.type} | x: ${poi.x}%, y: ${poi.y}%</div>
                    </div>
                    <button onclick="removePOI(${i})">X</button>
                </div>
            `).join('');
        }

        function removePOI(index) {
            const removed = pois.splice(index, 1)[0];

            // Unmark quick name
            document.querySelectorAll('.quick-name-btn').forEach(btn => {
                if (btn.textContent === removed.name) {
                    btn.classList.remove('used');
                }
            });

            updatePOIList();
            redraw();
        }

        function clearAll() {
            if (confirm('Clear all POIs?')) {
                pois = [];
                document.querySelectorAll('.quick-name-btn').forEach(btn => {
                    btn.classList.remove('used');
                    btn.style.background = '';
                    btn.style.color = '';
                });
                selectedName = '';
                updatePOIList();
                redraw();
            }
        }

        function exportPOIs() {
            const output = document.getElementById('output');
            output.style.display = 'block';

            const exportData = {
                mapSize: { width: imageWidth, height: imageHeight },
                pois: pois
            };

            output.textContent = JSON.stringify(exportData, null, 2);
        }

        function zoomIn() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const factor = 1.3;
            const newZoom = Math.min(2, zoom * factor);

            const zoomRatio = newZoom / zoom;
            panX = centerX - (centerX - panX) * zoomRatio;
            panY = centerY - (centerY - panY) * zoomRatio;

            zoom = newZoom;
            redraw();
        }

        function zoomOut() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const factor = 0.7;
            const newZoom = Math.max(0.05, zoom * factor);

            const zoomRatio = newZoom / zoom;
            panX = centerX - (centerX - panX) * zoomRatio;
            panY = centerY - (centerY - panY) * zoomRatio;

            zoom = newZoom;
            redraw();
        }

        function resetView() {
            zoom = 0.15;
            panX = 0;
            panY = 0;
            redraw();
        }

        function fitToScreen() {
            const scaleX = canvas.width / imageWidth;
            const scaleY = canvas.height / imageHeight;
            zoom = Math.min(scaleX, scaleY) * 0.95;

            panX = (canvas.width - imageWidth * zoom) / 2;
            panY = (canvas.height - imageHeight * zoom) / 2;
            redraw();
        }

        function toggleGrid() {
            showGrid = !showGrid;
            redraw();
        }

        init();
    </script>
</body>
</html>
